################################################################################
# Pull Request Validation - Fast feedback for PRs
# 
# This workflow runs quick checks on pull requests for fast feedback:
# - Code linting
# - Unit tests only (no integration tests)
# - Build validation
################################################################################

name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Cancel previous runs for the same PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  DEVOPS_REPO_NAME: ${{ secrets.DEVOPS_REPO_NAME || 'projectdevops' }}
  DEVOPS_REPO_OWNER: ${{ secrets.DEVOPS_REPO_OWNER || 'orshalit' }}

jobs:
  quick-checks:
    name: Quick Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout DEVOPS repository (for Dhall type imports)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DEVOPS_REPO_OWNER }}/${{ env.DEVOPS_REPO_NAME }}
          ssh-key: ${{ secrets.DEVOPS_REPO_KEY }}
          path: DEVOPS
          ref: main
      
      - name: Detect app directories
        id: detect-apps
        run: |
          BACKEND_APPS=$(find applications -mindepth 2 -maxdepth 2 -type d -name "backend" -exec dirname {} \; | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(length > 0))' || echo '[]')
          FRONTEND_APPS=$(find applications -mindepth 2 -maxdepth 2 -type d -name "frontend" -exec dirname {} \; | xargs -n1 basename | jq -R -s -c 'split("\n") | map(select(length > 0))' || echo '[]')
          echo "backend_apps=$BACKEND_APPS" >> $GITHUB_OUTPUT
          echo "frontend_apps=$FRONTEND_APPS" >> $GITHUB_OUTPUT
          echo "::notice::Detected backend apps: $BACKEND_APPS"
          echo "::notice::Detected frontend apps: $FRONTEND_APPS"
      
      - name: Set up Python
        if: steps.detect-apps.outputs.backend_apps != '[]'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        if: steps.detect-apps.outputs.frontend_apps != '[]'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Python dependencies for all apps
        if: steps.detect-apps.outputs.backend_apps != '[]'
        run: |
          for app_name in $(echo "${{ steps.detect-apps.outputs.backend_apps }}" | jq -r '.[]'); do
            app_backend_dir="applications/$app_name/backend"
            if [ -d "$app_backend_dir" ] && [ -f "$app_backend_dir/requirements-dev.txt" ]; then
              echo "::group::Installing dependencies for $app_name backend"
              python -m pip install --upgrade pip
              pip install -r "$app_backend_dir/requirements-dev.txt"
              echo "::endgroup::"
            fi
          done
      
      - name: Install Node.js dependencies for all apps
        if: steps.detect-apps.outputs.frontend_apps != '[]'
        run: |
          for app_name in $(echo "${{ steps.detect-apps.outputs.frontend_apps }}" | jq -r '.[]'); do
            app_frontend_dir="applications/$app_name/frontend"
            if [ -d "$app_frontend_dir" ] && [ -f "$app_frontend_dir/package-lock.json" ]; then
              echo "::group::Installing dependencies for $app_name frontend"
              cd "$app_frontend_dir"
              npm ci
              cd - > /dev/null
              echo "::endgroup::"
            fi
          done
      
      - name: Run backend unit tests for all apps
        if: steps.detect-apps.outputs.backend_apps != '[]'
        continue-on-error: true
        run: |
          for app_name in $(echo "${{ steps.detect-apps.outputs.backend_apps }}" | jq -r '.[]'); do
            app_backend_dir="applications/$app_name/backend"
            if [ -d "$app_backend_dir" ] && [ -d "$app_backend_dir/tests" ]; then
              echo "::group::Running unit tests for $app_name backend"
              cd "$app_backend_dir"
              env TESTING='true' pytest -m unit --verbose --tb=short -x || echo "::warning::Tests failed for $app_name backend"
              cd - > /dev/null
              echo "::endgroup::"
            fi
          done
      
      - name: Run frontend tests for all apps
        if: steps.detect-apps.outputs.frontend_apps != '[]'
        continue-on-error: true
        run: |
          for app_name in $(echo "${{ steps.detect-apps.outputs.frontend_apps }}" | jq -r '.[]'); do
            app_frontend_dir="applications/$app_name/frontend"
            if [ -d "$app_frontend_dir" ] && [ -f "$app_frontend_dir/package.json" ]; then
              echo "::group::Running tests for $app_name frontend"
              cd "$app_frontend_dir"
              if npm run | grep -q "test"; then
                npm test -- --watchAll=false --ci --bail || echo "::warning::Tests failed for $app_name frontend"
              else
                echo "::notice::No test script found for $app_name frontend"
              fi
              cd - > /dev/null
              echo "::endgroup::"
            fi
          done
      
      - name: Verify Docker builds for all apps
        continue-on-error: true
        run: |
          for app_name in $(echo "${{ steps.detect-apps.outputs.backend_apps }}" | jq -r '.[]'); do
            app_backend_dir="applications/$app_name/backend"
            if [ -d "$app_backend_dir" ] && [ -f "$app_backend_dir/Dockerfile" ]; then
              echo "::group::Building Docker image for $app_name backend"
              docker build -t "$app_name-backend:pr" "$app_backend_dir" || echo "::warning::Docker build failed for $app_name backend"
              echo "::endgroup::"
            fi
          done
          
          for app_name in $(echo "${{ steps.detect-apps.outputs.frontend_apps }}" | jq -r '.[]'); do
            app_frontend_dir="applications/$app_name/frontend"
            if [ -d "$app_frontend_dir" ] && [ -f "$app_frontend_dir/Dockerfile" ]; then
              echo "::group::Building Docker image for $app_name frontend"
              docker build -t "$app_name-frontend:pr" "$app_frontend_dir" || echo "::warning::Docker build failed for $app_name frontend"
              echo "::endgroup::"
            fi
          done
      
      - name: Check for Dhall service spec changes
        id: check_dhall_changes
        run: |
          # Fetch base branch for comparison
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }} || true
          
          # Check if any Dhall service spec files were changed
          if git diff --name-only ${{ github.base_ref }}...HEAD | grep -E '^dhall/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Dhall service specs
        if: steps.check_dhall_changes.outputs.changed == 'true'
        run: |
          echo "Validating Dhall service definitions..."
          
          # Verify DEVOPS checkout
          if [ ! -f "DEVOPS/config/types/Service.dhall" ]; then
            echo "::error::DEVOPS/config/types/Service.dhall not found!"
            exit 1
          fi
          echo "✓ DEVOPS checkout verified"
          
          # Update Dhall imports to use local DEVOPS path
          find dhall -name "*.dhall" -type f | while read -r file; do
            if grep -q "raw.githubusercontent.com.*projectdevops" "$file" 2>/dev/null; then
              echo "Updating: $file"
              FILE_DIR=$(dirname "$file")
              DEPTH=$(echo "$FILE_DIR" | tr '/' '\n' | wc -l)
              REL_PATH=""
              for i in $(seq 1 $DEPTH); do REL_PATH="../$REL_PATH"; done
              sed -i "s|https://raw.githubusercontent.com/[^/]*/projectdevops/[^/]*/config/|${REL_PATH}DEVOPS/config/|g" "$file"
            fi
          done
          
          # Install Dhall
          curl -L https://github.com/dhall-lang/dhall-haskell/releases/download/1.41.2/dhall-1.41.2-x86_64-linux.tar.bz2 | tar -xj
          sudo mv ./bin/dhall /usr/local/bin/
          dhall --version
          
          # Validate Dhall files
          if [ -f "dhall/services.dhall" ]; then
            echo "::notice::Type-checking dhall/services.dhall..."
            dhall type --file dhall/services.dhall || {
              echo "::error::Dhall type-checking failed!"
              exit 1
            }
            echo "✓ Dhall service spec validation passed"
          else
            echo "::warning::No dhall/services.dhall found. Skipping validation."
          fi
      
      - name: PR feedback
        if: always()
        run: |
          echo "## PR Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Quick checks completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "- Full CI pipeline will run after merge to main" >> $GITHUB_STEP_SUMMARY
          echo "- Integration tests will be executed" >> $GITHUB_STEP_SUMMARY
          echo "- Docker images will be published" >> $GITHUB_STEP_SUMMARY

