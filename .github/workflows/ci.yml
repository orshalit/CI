################################################################################
# CI/CD Pipeline - Production Grade
# 
# This workflow provides comprehensive CI/CD including:
# - Code quality checks (linting, formatting)
# - Security scanning
# - Unit and integration testing
# - Test coverage reporting
# - Docker image building with versioning
# - Multi-environment deployment
# - Artifact publishing
################################################################################

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags:
      - 'v*'  # Always run on version tags
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'scripts/**'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
      - '.github/workflows/ci.yml'  # Run if CI workflow itself changes
  pull_request:
    branches: [main, develop]
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'scripts/**'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
      - '.github/workflows/ci.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

# Cancel in-progress runs of the same workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ===========================================================================
  # Code Quality Checks
  # ===========================================================================
  
  code-quality:
    name: Code Quality & Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements-dev.txt
      
      - name: Install Python dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install Node.js dependencies
        working-directory: ./frontend
        run: npm ci
      
      # Python code quality - FAST (Ruff + Black)
      - name: Run Ruff linter âš¡ (replaces Flake8, Pylint, isort)
        working-directory: ./backend
        run: ruff check . --output-format=github
      
      - name: Check Python code formatting (Black)
        working-directory: ./backend
        run: black --check .
      
      # JavaScript code quality - FAST (ESLint + Prettier)
      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint
      
      - name: Check JavaScript formatting (Prettier)
        working-directory: ./frontend
        run: |
          npm run format:check || (echo "âš ï¸  Formatting issues found. Run 'npm run format' locally with Node 20+ to fix." && exit 1)
      
      # Dependency Auditing
      - name: Audit Python dependencies
        working-directory: ./backend
        continue-on-error: true  # Report but don't fail on vulnerabilities
        run: |
          pip install pip-audit
          pip-audit -r requirements.txt --desc on || echo "âš ï¸  Vulnerabilities found in Python dependencies"
      
      - name: Audit Node.js dependencies
        working-directory: ./frontend
        continue-on-error: true  # Report but don't fail on vulnerabilities
        run: |
          npm audit --audit-level=high || echo "âš ï¸  Vulnerabilities found in Node.js dependencies"
      
      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || github.event.before || 'HEAD~1' }}
          head: ${{ github.event.pull_request.head.sha || github.sha }}
          extra_args: --only-verified
        continue-on-error: ${{ github.event.before == github.sha }}

  # ===========================================================================
  # Backend Testing
  # ===========================================================================
  
  backend-tests:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test-type: [unit, integration]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements-dev.txt
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run unit tests
        if: matrix.test-type == 'unit'
        working-directory: ./backend
        env:
          TESTING: 'true'
          RATE_LIMIT_ENABLED: 'false'
        run: |
          pytest -m unit \
            --verbose \
            --tb=short \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=junit-unit.xml \
            tests/
      
      - name: Run integration tests
        if: matrix.test-type == 'integration'
        working-directory: ./backend
        env:
          TESTING: 'false'
          BACKEND_URL: 'http://localhost:8000'
        run: |
          # Start services for integration tests
          cd ..
          docker compose up -d database backend
          
          # Wait for services
          timeout 60 bash -c 'until curl -f http://localhost:8000/health; do sleep 2; done'
          
          # Run integration tests
          cd backend
          pytest -m integration \
            --verbose \
            --tb=short \
            --junitxml=junit-integration.xml \
            tests/test_integration.py
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ matrix.test-type }}
          path: |
            backend/junit-*.xml
            backend/htmlcov/
            backend/coverage.xml
      
      - name: Upload coverage to Codecov
        if: matrix.test-type == 'unit'
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false
      
      - name: Stop services
        if: always() && matrix.test-type == 'integration'
        run: docker compose down -v

  # ===========================================================================
  # Frontend Testing
  # ===========================================================================
  
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run tests with coverage
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false --ci --maxWorkers=50%
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: |
            frontend/coverage/
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./frontend/coverage/coverage-final.json
          flags: frontend
          name: frontend-coverage
          fail_ci_if_error: false

  # ===========================================================================
  # Build Metadata Preparation
  # ===========================================================================
  
  prepare-build:
    name: Prepare Build Metadata
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.metadata.outputs.version }}
      commit: ${{ steps.metadata.outputs.commit }}
      branch: ${{ steps.metadata.outputs.branch }}
      build_date: ${{ steps.metadata.outputs.build_date }}
      is_release: ${{ steps.metadata.outputs.is_release }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git describe
      
      - name: Generate build metadata
        id: metadata
        run: |
          # Determine version
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${{ github.ref_name }}"
            IS_RELEASE="true"
          elif [[ "${{ github.ref }}" == refs/heads/main ]]; then
            VERSION="main-$(git rev-parse --short HEAD)"
            IS_RELEASE="false"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
            IS_RELEASE="false"
          fi
          
          # Get git metadata
          COMMIT=$(git rev-parse --short HEAD)
          BRANCH=${GITHUB_REF#refs/heads/}
          BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          
          # Output for use in other jobs
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "build_date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT
          
          # Display metadata
          echo "::notice::Build Version: ${VERSION}"
          echo "::notice::Git Commit: ${COMMIT}"
          echo "::notice::Git Branch: ${BRANCH}"
          echo "::notice::Build Date: ${BUILD_DATE}"

  # ===========================================================================
  # Change Detection
  # ===========================================================================
  
  detect-changes:
    name: Detect Code Changes
    runs-on: ubuntu-latest
    outputs:
      app-code: ${{ steps.filter.outputs.app-code }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for path filtering
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            app-code:
              - 'backend/**'
              - 'frontend/**'
              - 'Dockerfile*'
              - 'docker-compose*.yml'

  # ===========================================================================
  # Docker Image Building
  # ===========================================================================
  
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [code-quality, backend-tests, frontend-tests, prepare-build, detect-changes]
    # Only build images if app code changed, or on version tags, or manual dispatch
    if: |
      needs.detect-changes.outputs.app-code == 'true' ||
      startsWith(github.ref, 'refs/tags/v') ||
      github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=${{ needs.prepare-build.outputs.version }}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_VERSION=${{ needs.prepare-build.outputs.version }}
            GIT_COMMIT=${{ needs.prepare-build.outputs.commit }}
            GIT_BRANCH=${{ needs.prepare-build.outputs.branch }}
            BUILD_DATE=${{ needs.prepare-build.outputs.build_date }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64
      
      - name: Export image for testing
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          tags: ci-${{ matrix.service }}:test
          build-args: |
            BUILD_VERSION=${{ needs.prepare-build.outputs.version }}
            GIT_COMMIT=${{ needs.prepare-build.outputs.commit }}
            GIT_BRANCH=${{ needs.prepare-build.outputs.branch }}
            BUILD_DATE=${{ needs.prepare-build.outputs.build_date }}
          cache-from: type=gha,scope=${{ matrix.service }}
          load: true

  # ===========================================================================
  # End-to-End Tests
  # ===========================================================================
  
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build-images, prepare-build, detect-changes]
    # Only run E2E tests if app code changed, or on version tags, or manual dispatch
    if: |
      (needs.detect-changes.outputs.app-code == 'true' ||
       startsWith(github.ref, 'refs/tags/v') ||
       github.event_name == 'workflow_dispatch') &&
      needs.build-images.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Start services with docker compose
        env:
          BUILD_VERSION: ${{ needs.prepare-build.outputs.version }}
          GIT_COMMIT: ${{ needs.prepare-build.outputs.commit }}
          GIT_BRANCH: ${{ needs.prepare-build.outputs.branch }}
          BUILD_DATE: ${{ needs.prepare-build.outputs.build_date }}
        run: |
          docker compose up -d --build
      
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to be healthy..."
          
          echo "=== Waiting for database ==="
          timeout 120 bash -c '
            until docker compose ps database | grep -q "healthy"; do 
              echo "Waiting for database..."; 
              sleep 2; 
            done
          '
          echo "âœ“ Database is healthy"
          
          echo "=== Waiting for backend ==="
          timeout 120 bash -c '
            until docker compose ps backend | grep -q "healthy"; do 
              echo "Waiting for backend..."; 
              sleep 2; 
            done
          '
          echo "âœ“ Backend is healthy"
          
          echo "=== Waiting for frontend ==="
          echo "Container status before wait:"
          docker compose ps frontend
          
          timeout 120 bash -c '
            counter=0
            until docker compose ps frontend | grep -q "healthy"; do 
              counter=$((counter + 1))
              echo "Waiting for frontend... (attempt $counter)"
              
              # Every 10 attempts, show detailed debug info
              if [ $((counter % 10)) -eq 0 ]; then
                echo "--- Debug Info (attempt $counter) ---"
                echo "Container status:"
                docker compose ps frontend
                echo "Health check status:"
                docker inspect --format="{{json .State.Health}}" frontend 2>/dev/null | jq . || echo "No health info available"
                echo "Recent logs:"
                docker compose logs --tail=20 frontend
                echo "---"
              fi
              
              sleep 2
            done
          '
          echo "âœ“ Frontend is healthy"
      
      - name: Verify service health
        run: |
          echo "=== Service Status ==="
          docker compose ps
          
          echo -e "\n=== Database Health ==="
          docker compose exec -T database pg_isready -U appuser -d appdb
          
          echo -e "\n=== Backend Health ==="
          curl -f http://localhost:8000/health | jq .
          
          echo -e "\n=== Backend Version ==="
          curl -f http://localhost:8000/version | jq .
          
          echo -e "\n=== Frontend Health ==="
          curl -f http://localhost:3000/ > /dev/null
          
          echo -e "\n=== Frontend Version ==="
          curl -f http://localhost:3000/version.json | jq .
      
      - name: Run E2E API tests
        run: |
          echo "=== Testing Hello Endpoint ==="
          response=$(curl -s http://localhost:8000/api/hello)
          echo "$response" | jq .
          echo "$response" | jq -e '.message == "hello from backend"'
          
          echo "=== Testing Greet Endpoint ==="
          response=$(curl -s http://localhost:8000/api/greet/E2ETest)
          echo "$response" | jq .
          echo "$response" | jq -e '.message == "Hello, E2ETest!"'
          
          echo "=== Testing Get Greetings ==="
          response=$(curl -s http://localhost:8000/api/greetings)
          echo "$response" | jq .
          echo "$response" | jq -e '.total > 0'
          
          echo "=== Testing User Greetings ==="
          response=$(curl -s http://localhost:8000/api/greetings/E2ETest)
          echo "$response" | jq .
          echo "$response" | jq -e '.count > 0'
      
      - name: Test version metadata
        run: |
          echo "=== Verify Backend Version ==="
          response=$(curl -s http://localhost:8000/version)
          echo "$response" | jq .
          echo "$response" | jq -e '.version == "${{ needs.prepare-build.outputs.version }}"'
          echo "$response" | jq -e '.commit == "${{ needs.prepare-build.outputs.commit }}"'
          
          echo "=== Verify Frontend Version ==="
          response=$(curl -s http://localhost:3000/version.json)
          echo "$response" | jq .
          echo "$response" | jq -e '.version == "${{ needs.prepare-build.outputs.version }}"'
      
      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker compose ps -a
          
          echo -e "\n=== Container Health Details ==="
          for service in database backend frontend; do
            echo "--- $service health ---"
            docker inspect --format="{{json .State.Health}}" $service 2>/dev/null | jq . || echo "No health info for $service"
          done
          
          echo -e "\n=== Full Docker Compose Logs ==="
          docker compose logs --no-color
          
          echo -e "\n=== Frontend Container Inspect ==="
          docker inspect frontend 2>/dev/null | jq '.[0].State' || echo "Frontend container not found"
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  # ===========================================================================
  # Security Scanning
  # ===========================================================================
  
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-images, detect-changes]
    # Only scan if app code changed, or on version tags, or manual dispatch
    if: |
      github.event_name != 'pull_request' &&
      (needs.detect-changes.outputs.app-code == 'true' ||
       startsWith(github.ref, 'refs/tags/v') ||
       github.event_name == 'workflow_dispatch') &&
      needs.build-images.result == 'success'
    strategy:
      matrix:
        service: [backend, frontend]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}:latest'
          format: 'sarif'
          output: 'trivy-results-${{ matrix.service }}.sarif'
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results-${{ matrix.service }}.sarif'
      
      # Docker Scout - Advanced vulnerability analysis and recommendations
      - name: Login to Docker Hub (for Scout)
        if: github.event_name != 'pull_request'
        continue-on-error: true
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Debug Docker authentication
        run: |
          echo "=== Docker Authentication Debug ==="
          echo "Checking Docker login status..."
          docker info 2>&1 | grep -i "username\|registry" || echo "No username info in docker info"
          
          echo -e "\n=== Checking Docker config ==="
          if [ -f ~/.docker/config.json ]; then
            echo "Docker config file exists:"
            cat ~/.docker/config.json | jq '.auths // "No auths configured"' || cat ~/.docker/config.json
          else
            echo "No Docker config file found at ~/.docker/config.json"
          fi
          
          echo -e "\n=== Docker Scout availability ==="
          docker scout --version 2>&1 || echo "Docker Scout not available in PATH"
          
          echo -e "\n=== Image to scan ==="
          echo "Image: ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}:latest"
          echo "Repository owner: ${{ github.repository_owner }}"
          echo "Service: ${{ matrix.service }}"
          
          echo -e "\n=== Checking if image exists ==="
          docker manifest inspect ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}:latest 2>&1 | head -20 || echo "Cannot inspect image manifest"
          
          echo -e "\n=== Docker Scout Authentication Status ==="
          echo "Note: Docker Scout requires Docker Hub authentication"
          echo "Current user from docker info: $(docker info 2>&1 | grep -i 'username' | head -1 || echo 'unknown')"
          echo ""
          echo "If Docker Scout fails with 'not entitled', you need to:"
          echo "  1. Create a Docker Hub account at https://hub.docker.com (free)"
          echo "  2. Enable Docker Scout in your account (included in free Personal plan)"
          echo "  3. Create a Personal Access Token at https://hub.docker.com/settings/security"
          echo "  4. Add GitHub secrets: DOCKERHUB_USERNAME and DOCKERHUB_TOKEN"
      
      - name: Docker Scout CVE Analysis
        uses: docker/scout-action@v1
        continue-on-error: true  # Don't fail build, just report
        with:
          command: cves
          image: 'ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}:latest'
          summary: true
      
      - name: Docker Scout Recommendations
        uses: docker/scout-action@v1
        continue-on-error: true
        with:
          command: recommendations
          image: 'ghcr.io/${{ github.repository_owner }}/ci-${{ matrix.service }}:latest'

  # ===========================================================================
  # Release & Deployment
  # ===========================================================================
  
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [e2e-tests, prepare-build]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          # Simple changelog generation
          echo "## What's Changed" > CHANGELOG.txt
          git log --pretty=format:"* %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> CHANGELOG.txt
          cat CHANGELOG.txt
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.txt
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Summary
  # ===========================================================================
  
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, prepare-build, detect-changes, build-images]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`${{ needs.prepare-build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ needs.prepare-build.outputs.commit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ needs.prepare-build.outputs.branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build Date:** \`${{ needs.prepare-build.outputs.build_date }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          APP_CODE_CHANGED="${{ needs.detect-changes.outputs.app-code }}"
          IS_TAG="${{ startsWith(github.ref, 'refs/tags/v') }}"
          IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"
          
          if [ "$APP_CODE_CHANGED" == "true" ] || [ "$IS_TAG" == "true" ] || [ "$IS_MANUAL" == "true" ]; then
            echo "### ðŸ“¦ Images Built" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ github.repository_owner }}/ci-backend:${{ needs.prepare-build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`ghcr.io/${{ github.repository_owner }}/ci-frontend:${{ needs.prepare-build.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸  No Images Built" >> $GITHUB_STEP_SUMMARY
            echo "Skipped because no application code changed (only workflow/infrastructure files were modified)." >> $GITHUB_STEP_SUMMARY
          fi
