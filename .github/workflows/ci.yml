name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-tests:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run backend unit tests
        working-directory: ./backend
        run: |
          pytest tests/test_main.py -v --tb=short

  frontend-tests:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci
      
      - name: Run frontend tests
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false --ci

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: false
          tags: backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true
      
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: false
          tags: frontend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

  docker-compose-up:
    name: Start Docker Compose Services
    runs-on: ubuntu-latest
    needs: [build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build and start services
        run: |
          docker compose up -d --build
      
      - name: Wait for database to be healthy
        run: |
          echo "Waiting for database to be healthy..."
          timeout 60 bash -c 'until docker compose ps database | grep -q "healthy"; do sleep 2; done' || docker compose ps
      
      - name: Wait for backend to be healthy
        run: |
          echo "Waiting for backend to be healthy..."
          timeout 90 bash -c 'until docker compose ps backend | grep -q "healthy"; do sleep 2; done' || docker compose ps
      
      - name: Wait for frontend to be healthy
        run: |
          echo "Waiting for frontend to be healthy..."
          timeout 60 bash -c 'until docker compose ps frontend | grep -q "healthy"; do sleep 2; done' || docker compose ps
      
      - name: Check service status
        run: |
          docker compose ps
          echo "=== Service Logs ==="
          docker compose logs --tail=50

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [docker-compose-up]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      - name: Install test dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Verify services are running
        run: |
          docker compose ps
          echo "=== Backend Health Check ==="
          curl -f http://localhost:8000/health || exit 1
      
      - name: Run integration tests
        working-directory: ./backend
        env:
          BACKEND_URL: http://localhost:8000
        run: |
          pytest tests/test_integration.py -v --tb=short
      
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
      
      - name: Test API endpoints
        run: |
          echo "=== Testing Health Endpoint ==="
          curl -f http://localhost:8000/health | jq .
          
          echo "=== Testing Hello Endpoint ==="
          response=$(curl -s http://localhost:8000/api/hello)
          echo "$response" | jq .
          echo "$response" | grep -q "hello from backend" || exit 1
          
          echo "=== Testing Greet Endpoint ==="
          response=$(curl -s http://localhost:8000/api/greet/TestUser)
          echo "$response" | jq .
          echo "$response" | grep -q "Hello, TestUser" || exit 1
          
          echo "=== Testing Get Greetings Endpoint ==="
          curl -s http://localhost:8000/api/greetings | jq .
      
      - name: Stop services
        if: always()
        run: |
          docker compose down -v

