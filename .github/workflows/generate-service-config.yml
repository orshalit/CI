name: Generate Service Config

on:
  push:
    branches:
      - main
    paths:
      - 'dhall/**'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-service-pr:
    name: Generate DEVOPS PR from Dhall service specs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout CI repository
        uses: actions/checkout@v4

      - name: Install Dhall
        run: |
          # Install core dhall interpreter
          curl -L https://github.com/dhall-lang/dhall-haskell/releases/download/1.41.2/dhall-1.41.2-x86_64-linux.tar.bz2 | tar -xj
          sudo mv ./bin/dhall /usr/local/bin/
          dhall --version

          # Install dhall-json for dhall-to-json
          curl -L https://github.com/dhall-lang/dhall-haskell/releases/download/1.41.2/dhall-json-1.41.2-x86_64-linux.tar.bz2 | tar -xj
          sudo mv ./bin/dhall-to-json /usr/local/bin/
          dhall-to-json --version

      - name: Convert Dhall to JSON
        id: convert
        run: |
          echo "::notice::Converting Dhall service definitions to JSON..."
          dhall-to-json --file dhall/services.dhall > services.generated.json
          echo "::notice::âœ“ Conversion successful."
          echo "::group::Generated JSON"
          cat services.generated.json
          echo "::endgroup::"

      - name: Checkout DEVOPS repository
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.DEVOPS_REPO_NAME || 'orshalit/DEVOPS' }}
          path: DEVOPS
          ssh-key: ${{ secrets.DEVOPS_REPO_KEY }}

      - name: Move generated JSON to DEVOPS repo
        run: |
          mkdir -p DEVOPS/live/dev/04-ecs-fargate
          mv services.generated.json DEVOPS/live/dev/04-ecs-fargate/services.generated.json

      - name: Check for changes
        id: check_changes
        run: |
          cd DEVOPS
          git add -A
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "::notice::No changes detected - services.generated.json is already up to date."
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "::notice::Changes detected - will create pull request."
            git diff --staged --stat
          fi

      - name: Create pull request in DEVOPS
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          path: DEVOPS
          commit-message: "feat: update ECS services from CI Dhall specs"
          branch: "ci-generated/ecs-services"
          title: "feat: Update ECS services from CI Dhall specs"
          body: |
            This PR was automatically generated by a GitHub Actions workflow in the `${{ github.repository }}` repository.

            It contains the updated ECS service configurations, converted from the Dhall source files in the `CI` repository.

            **Source Commit:** `${{ github.sha }}`

            Please review the generated `services.generated.json` and merge to approve the changes for deployment.
          token: ${{ secrets.DEVOPS_REPO_TOKEN || secrets.GITHUB_TOKEN }}
