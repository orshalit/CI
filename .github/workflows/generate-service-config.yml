name: Validate Dhall Service Config

on:
  push:
    branches:
      - main
    paths:
      - 'dhall/**'
  pull_request:
    branches:
      - main
    paths:
      - 'dhall/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-dhall-services:
    name: Validate Dhall Service Definitions
    runs-on: ubuntu-latest
    description: |
      Validates Dhall service definitions for correctness.
      Note: services.generated.json is now generated on-demand during deployment,
      so this workflow only validates the Dhall files.

    steps:
      - name: Checkout CI repository
        uses: actions/checkout@v4

      - name: Install Dhall
        run: |
          # Install core dhall interpreter
          curl -L https://github.com/dhall-lang/dhall-haskell/releases/download/1.41.2/dhall-1.41.2-x86_64-linux.tar.bz2 | tar -xj
          sudo mv ./bin/dhall /usr/local/bin/
          dhall --version

          # Install dhall-json for dhall-to-json
          curl -L https://github.com/dhall-lang/dhall-haskell/releases/download/1.41.2/dhall-json-1.41.2-x86_64-linux.tar.bz2 | tar -xj
          sudo mv ./bin/dhall-to-json /usr/local/bin/
          dhall-to-json --version

      - name: Type-check Dhall service definitions
        run: |
          echo "::notice::Type-checking dhall/services.dhall..."
          dhall type --file dhall/services.dhall
          echo "::notice::✓ Type-check passed"

      - name: Validate Dhall to JSON conversion
        run: |
          echo "::notice::Validating JSON conversion..."
          dhall-to-json --file dhall/services.dhall > /tmp/services.generated.json
          
          # Validate JSON structure
          if ! jq empty /tmp/services.generated.json 2>/dev/null; then
            echo "::error::Generated JSON is invalid"
            cat /tmp/services.generated.json
            exit 1
          fi
          
          SERVICE_COUNT=$(jq 'keys | length' /tmp/services.generated.json)
          echo "::notice::✓ JSON conversion successful"
          echo "::notice::✓ Found $SERVICE_COUNT service(s)"
          
          echo "::group::Service names"
          jq -r 'keys[]' /tmp/services.generated.json
          echo "::endgroup::"
          
          echo "::group::Generated JSON preview"
          cat /tmp/services.generated.json | jq '.' | head -50
          echo "::endgroup::"

      - name: Summary
        if: always()
        run: |
          echo "## Dhall Validation Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** This workflow validates Dhall service definitions." >> $GITHUB_STEP_SUMMARY
          echo "The actual \`services.generated.json\` file is generated on-demand during deployment." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This ensures:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ No PR bottlenecks" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Always uses latest service definitions" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Type-safe and validated" >> $GITHUB_STEP_SUMMARY
